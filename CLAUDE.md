# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Build & Development Commands

```bash
pnpm install          # Install dependencies
pnpm build            # TypeScript compile
pnpm test             # Run all tests
pnpm test:watch       # Run tests in watch mode
pnpm lint             # Biome linting
pnpm format           # Biome formatting
pnpm check            # Biome lint + format (auto-fix)
```

### Database Commands

```bash
pnpm db:generate      # Generate migrations from schema changes
pnpm db:migrate       # Apply migrations to DATABASE_URL
pnpm db:push          # Push schema directly (dev only)
pnpm db:studio        # Open Drizzle Studio UI
```

### Running a Single Test

```bash
pnpm test -- src/repositories/context.repository.test.ts
pnpm test -- -t "creates a context"  # Run tests matching name pattern
```

## Architecture

**Kata Context** is a context policy engine for AI agents. It manages what goes into LLM context windows - handling storage, retrieval, and token-budgeted windowing. Framework-agnostic.

### Code Structure

```
src/
├── db/
│   ├── client.ts           # Drizzle + pg Pool (Vercel Fluid-aware)
│   ├── schema/             # Drizzle table definitions
│   │   ├── contexts.ts     # contexts table (soft-delete, fork tracking)
│   │   └── messages.ts     # messages table (versioned, pgvector-ready)
│   └── migrations/         # SQL migrations (generated by drizzle-kit)
├── repositories/           # Data access layer
│   ├── context.repository.ts   # Context CRUD, soft-delete
│   ├── message.repository.ts   # Message append, pagination, token budgeting
│   ├── types.ts            # Input/output types, RepositoryError
│   └── helpers.ts          # notDeleted filter, error handling
api/
└── health.ts               # Vercel serverless health endpoint
```

### Key Patterns

- **Soft delete**: Entities have `deletedAt` timestamp; queries filter via `notDeleted()` helper
- **Versioned messages**: Each message gets a sequential `version` number per context, enabling cursor-based pagination
- **Token budgeting**: `MessageRepository.getByTokenBudget()` returns the most recent messages fitting a token budget
- **Batch insert with locking**: `MessageRepository.append()` uses `FOR UPDATE` to prevent version conflicts

### Database

- **ORM**: Drizzle ORM with PostgreSQL dialect
- **Production**: Neon Postgres with connection pooling (DATABASE_URL must contain `-pooler`)
- **Testing**: PGlite in-memory database with pgvector extension
- **Migrations**: Located in `src/db/migrations/`, applied via `drizzle-kit`

### Testing

Tests use PGlite (in-memory Postgres) - no external database needed. Setup in `vitest.setup.ts`:
- Creates fresh PGlite instance per test file
- Runs migrations automatically
- Includes pgvector extension

## Local Development

### Vercel Dev Limitation

`vercel dev` does not reliably execute serverless functions locally. Functions return 404 locally but work in production.

**Workaround**: Use local dev server for API development:
```bash
pnpm dev:local  # Runs tsx with .env loaded
```

### Environment Variables

Required: `DATABASE_URL` - Neon Postgres connection string (must include `-pooler` for production)
