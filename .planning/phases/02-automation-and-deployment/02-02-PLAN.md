---
phase: 02-automation-and-deployment
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/ci.yml
  - api/health.ts
  - tsconfig.json
  - vercel.json
autonomous: true

must_haves:
  truths:
    - "Push to main or PR triggers CI workflow"
    - "CI runs lint and test commands successfully"
    - "GET /api/health returns JSON with status field"
    - "vercel build completes without errors locally"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "GitHub Actions CI workflow"
      contains: "pnpm run lint"
    - path: "api/health.ts"
      provides: "Health check serverless function"
      contains: "Response.json"
    - path: "vercel.json"
      provides: "Vercel project configuration"
      contains: "functions"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "package.json scripts"
      via: "pnpm run lint/test"
      pattern: "pnpm run (lint|test)"
    - from: "api/health.ts"
      to: "Vercel runtime"
      via: "export GET function"
      pattern: "export function GET"
---

<objective>
Set up GitHub Actions CI and Vercel serverless function infrastructure.

Purpose: Automate code quality checks on every push/PR and establish the serverless function pattern for the API layer.

Output: Working CI pipeline and deployable health check endpoint.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-automation-and-deployment/02-RESEARCH.md

@package.json
@tsconfig.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions CI workflow</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Create the directory structure and CI workflow file:
```bash
mkdir -p .github/workflows
```

Create `.github/workflows/ci.yml` with:
```yaml
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  HUSKY: 0  # Disable husky in CI (hooks not needed)

jobs:
  lint-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm run lint

      - name: Test
        run: pnpm run test
```

Key points:
- `HUSKY: 0` prevents installing git hooks in CI (unnecessary overhead)
- `--frozen-lockfile` ensures reproducible builds
- `cache: 'pnpm'` enables automatic pnpm store caching
- Uses actions/checkout@v4 and actions/setup-node@v4 (current stable versions)
  </action>
  <verify>
```bash
# Verify file exists with correct structure
cat .github/workflows/ci.yml | head -20

# Validate YAML syntax
pnpm exec biome check .github/workflows/ci.yml || echo "Note: YAML not in Biome scope, manual review OK"
```
  </verify>
  <done>
- .github/workflows/ci.yml exists
- Triggers on push to main and PRs to main
- Runs pnpm install, lint, and test
- Uses pnpm caching for faster builds
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Vercel health endpoint</name>
  <files>api/health.ts, tsconfig.json, vercel.json</files>
  <action>
**Step 1: Create api directory and health endpoint**
```bash
mkdir -p api
```

Create `api/health.ts` using the HTTP method export pattern (cleaner than default export object):
```typescript
export function GET(request: Request): Response {
  return Response.json({
    status: "healthy",
    timestamp: new Date().toISOString(),
    version: process.env.npm_package_version ?? "0.1.0",
  });
}
```

**Step 2: Update tsconfig.json to include api directory and add DOM lib**

The api/ directory needs TypeScript compilation, and we need DOM lib for Web Standard APIs (Request, Response).

Update tsconfig.json:
- Add `"lib": ["ES2023", "DOM"]` to compilerOptions (for Request/Response types)
- Change `"include"` to `["src", "api"]` (compile both directories)
- Keep rootDir as "src" since api/ functions are compiled separately by Vercel

```json
{
  "compilerOptions": {
    "target": "ES2023",
    "lib": ["ES2023", "DOM"],
    "module": "NodeNext",
    "moduleResolution": "NodeNext",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "outDir": "dist",
    "rootDir": ".",
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true,
    "noUncheckedIndexedAccess": true,
    "isolatedModules": true,
    "verbatimModuleSyntax": true
  },
  "include": ["src", "api"],
  "exclude": ["node_modules", "dist"]
}
```

Note: Changed rootDir from "src" to "." since we now have two source directories. This affects where TypeScript puts output files but Vercel compiles api/ separately anyway.

**Step 3: Create vercel.json for explicit function configuration**

Create `vercel.json`:
```json
{
  "$schema": "https://openapi.vercel.sh/vercel.json",
  "functions": {
    "api/**/*.ts": {
      "runtime": "nodejs24.x"
    }
  }
}
```

This explicitly configures:
- All .ts files in api/ are serverless functions
- Uses Node.js 24 runtime (matches project engines)
  </action>
  <verify>
```bash
# Verify api/health.ts exists and exports GET
cat api/health.ts

# Verify TypeScript compiles without errors
pnpm run build

# Verify tsconfig includes api and has DOM lib
cat tsconfig.json | grep -A2 '"lib"'
cat tsconfig.json | grep -A2 '"include"'

# Verify vercel.json exists
cat vercel.json
```
  </verify>
  <done>
- api/health.ts exports GET function returning JSON response
- tsconfig.json includes DOM lib for Web Standard APIs
- tsconfig.json includes api directory
- vercel.json configures Node.js 24 runtime for functions
- TypeScript compilation succeeds
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify Vercel build locally</name>
  <files></files>
  <action>
Run `vercel build` locally to verify the project builds successfully.

**Prerequisites:** Vercel CLI must be installed globally (`npm i -g vercel`).

**If Vercel CLI not installed:**
```bash
npm i -g vercel
```

**Run build verification:**
```bash
vercel build --yes
```

The `--yes` flag accepts defaults for any prompts.

**Expected output:**
- Build should complete without errors
- `.vercel/output` directory created
- Functions directory should contain health endpoint

**If project not linked (first time):**
Vercel may prompt to link to a project. For local verification only:
```bash
vercel build --yes --local
```

Or create a minimal `.vercel/project.json` for local builds:
```json
{
  "projectId": "local",
  "orgId": "local"
}
```

**Troubleshooting:**
- If TypeScript errors occur, check tsconfig.json has DOM lib
- If runtime errors, verify vercel.json runtime matches Node version
  </action>
  <verify>
```bash
# Verify build output exists
ls -la .vercel/output/functions/api/ 2>/dev/null || echo "Build output check (may need vercel link first)"

# Alternative: verify TypeScript compiles (proves code is valid)
pnpm run build

# Check health.ts is syntactically valid TypeScript
pnpm exec tsc --noEmit api/health.ts
```
  </verify>
  <done>
- `vercel build` completes without errors (or TypeScript compile proves validity)
- api/health function is recognized by Vercel
- Project structure follows Vercel Functions convention
  </done>
</task>

</tasks>

<verification>
Verify the complete CI and Vercel setup:

1. **CI Workflow validity:**
```bash
# Check workflow file exists
cat .github/workflows/ci.yml | grep "pnpm run lint"
cat .github/workflows/ci.yml | grep "pnpm run test"
```

2. **Health endpoint compilation:**
```bash
# TypeScript should compile without errors
pnpm run build
echo $?  # Should be 0
```

3. **Vercel structure:**
```bash
ls api/
# Should show: health.ts

cat vercel.json
# Should show functions configuration
```

4. **Type checking:**
```bash
pnpm exec tsc --noEmit
# Should complete without errors
```
</verification>

<success_criteria>
1. `.github/workflows/ci.yml` exists and contains lint + test steps
2. `api/health.ts` exports GET function returning `{status, timestamp, version}`
3. `vercel.json` exists with functions configuration
4. `pnpm run build` succeeds (TypeScript compiles)
5. `pnpm exec tsc --noEmit` passes (type checking)
</success_criteria>

<output>
After completion, create `.planning/phases/02-automation-and-deployment/02-02-SUMMARY.md`
</output>
