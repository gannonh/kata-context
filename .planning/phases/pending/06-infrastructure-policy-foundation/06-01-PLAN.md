---
phase: 06-infrastructure-policy-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - pnpm-lock.yaml
  - src/db/schema/contexts.ts
  - src/db/schema/messages.ts
  - src/validation/policy.ts
  - src/token-counting/index.ts
  - src/db/migrations/ (generated)
autonomous: true

must_haves:
  truths:
    - "gpt-tokenizer is installed and countTokens returns integer token counts for arbitrary strings"
    - "contexts table has a nullable policy_config JSONB column"
    - "messages table has nullable compacted_at and compacted_into_version columns"
    - "Policy config schema validates and applies defaults for threshold, preserveRecentCount, enabled"
    - "Migration applies cleanly against PGlite in test suite"
  artifacts:
    - path: "src/token-counting/index.ts"
      provides: "Token counting utility wrapping gpt-tokenizer"
      exports: ["countMessageTokens"]
    - path: "src/validation/policy.ts"
      provides: "Zod schema for policy config with defaults"
      exports: ["policyConfigSchema", "PolicyConfig", "DEFAULT_POLICY", "resolvePolicy"]
    - path: "src/db/schema/contexts.ts"
      provides: "policyConfig JSONB column on contexts table"
      contains: "policyConfig"
    - path: "src/db/schema/messages.ts"
      provides: "compactedAt and compactedIntoVersion columns on messages table"
      contains: "compactedAt"
  key_links:
    - from: "src/validation/policy.ts"
      to: "src/db/schema/contexts.ts"
      via: "PolicyConfig type used by .$type<PolicyConfig>()"
      pattern: "\\$type<PolicyConfig>"
    - from: "src/token-counting/index.ts"
      to: "gpt-tokenizer"
      via: "import countTokens"
      pattern: "from \"gpt-tokenizer\""
---

<objective>
Add infrastructure dependencies and schema extensions for the policy engine.

Purpose: Establish the data layer foundation (new columns, validation schema, token counting) that Plan 02 and all subsequent v0.3.0 phases depend on.
Output: gpt-tokenizer installed, schema extended with 3 new columns, migration generated, policy validation module created, token counting utility created.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/pending/06-infrastructure-policy-foundation/06-RESEARCH.md
@src/db/schema/contexts.ts
@src/db/schema/messages.ts
@src/db/schema/index.ts
@src/api/validation/schemas.ts
@vitest.setup.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install gpt-tokenizer, create token counting utility and policy validation module</name>
  <files>
    package.json
    pnpm-lock.yaml
    src/token-counting/index.ts
    src/validation/policy.ts
  </files>
  <action>
1. Install gpt-tokenizer:
   ```bash
   pnpm add gpt-tokenizer
   ```

2. Create `src/token-counting/index.ts`:
   - Import `countTokens` from `"gpt-tokenizer"` (default o200k_base encoding)
   - Export `countMessageTokens(content: string): number` that delegates to `countTokens`
   - Keep it minimal. No model-specific encoding yet.

3. Create `src/validation/policy.ts`:
   - Import `z` from `"zod/v4"` (matches existing codebase pattern in `src/api/validation/schemas.ts`)
   - Define `policyConfigSchema` as a Zod object with:
     - `threshold`: `z.number().min(0).max(1).default(0.8)`
     - `preserveRecentCount`: `z.number().int().min(0).default(10)`
     - `enabled`: `z.boolean().default(true)`
   - Export `type PolicyConfig = z.infer<typeof policyConfigSchema>`
   - Export `const DEFAULT_POLICY: PolicyConfig = policyConfigSchema.parse({})`
   - Export `function resolvePolicy(input: unknown): PolicyConfig` that returns `policyConfigSchema.parse(input ?? {})`

Important: Use `"zod/v4"` import path, not `"zod"`. The existing codebase uses this path.
  </action>
  <verify>
    - `pnpm build` compiles without errors
    - `node -e "import('gpt-tokenizer').then(m => console.log(typeof m.countTokens))"` prints `function`
    - Manually verify `src/validation/policy.ts` exports DEFAULT_POLICY with expected shape
  </verify>
  <done>
    - gpt-tokenizer in package.json dependencies
    - `countMessageTokens` exported from `src/token-counting/index.ts`
    - `policyConfigSchema`, `PolicyConfig`, `DEFAULT_POLICY`, `resolvePolicy` exported from `src/validation/policy.ts`
    - `resolvePolicy({})` returns `{ threshold: 0.8, preserveRecentCount: 10, enabled: true }`
    - `resolvePolicy({ threshold: 0.5 })` returns `{ threshold: 0.5, preserveRecentCount: 10, enabled: true }`
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend database schema with new columns and generate migration</name>
  <files>
    src/db/schema/contexts.ts
    src/db/schema/messages.ts
    src/db/migrations/ (new migration file)
  </files>
  <action>
1. Modify `src/db/schema/contexts.ts`:
   - Add import for `jsonb` from `"drizzle-orm/pg-core"`
   - Import `type PolicyConfig` from `"../validation/policy.js"`
   - Add column: `policyConfig: jsonb("policy_config").$type<PolicyConfig>()`
   - Place it after `forkVersion` and before `deletedAt`
   - Column is nullable (no `.notNull()`). NULL means "use system defaults."

2. Modify `src/db/schema/messages.ts`:
   - Add column: `compactedAt: timestamp("compacted_at", { withTimezone: true })`
   - Add column: `compactedIntoVersion: bigint("compacted_into_version", { mode: "number" })`
   - Place them after `deletedAt` and before `embedding`
   - Both columns are nullable (no `.notNull()`)

3. Generate migration:
   ```bash
   pnpm db:generate
   ```
   - Verify the generated SQL contains:
     - `ALTER TABLE "contexts" ADD COLUMN "policy_config" jsonb;`
     - `ALTER TABLE "messages" ADD COLUMN "compacted_at" timestamp with time zone;`
     - `ALTER TABLE "messages" ADD COLUMN "compacted_into_version" bigint;`
   - No UPDATE statements (no backfill)
   - No NOT NULL constraints on new columns

4. Run tests to verify migration applies against PGlite:
   ```bash
   pnpm test
   ```
   All existing tests must pass. The migration runs in `vitest.setup.ts` via `migrate()`.
  </action>
  <verify>
    - `pnpm db:generate` succeeds and creates a new migration file
    - Generated SQL contains the 3 expected ALTER TABLE statements
    - `pnpm test` passes (all existing tests still green)
    - `pnpm build` compiles without errors
  </verify>
  <done>
    - `contexts` schema includes `policyConfig` JSONB column typed as `PolicyConfig`
    - `messages` schema includes `compactedAt` timestamp and `compactedIntoVersion` bigint
    - Migration file exists in `src/db/migrations/`
    - All existing tests pass with the new migration applied
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` compiles with zero errors
2. `pnpm test` passes with all existing tests green
3. `pnpm lint` passes
4. New migration file exists and contains only additive ALTER TABLE statements
5. No backfill UPDATE statements in migration
</verification>

<success_criteria>
- gpt-tokenizer installed and token counting utility functional
- Policy validation schema produces correct defaults and merges partial input
- Schema extended with 3 new nullable columns
- Migration generated and verified against PGlite
- All existing tests pass unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/pending/06-infrastructure-policy-foundation/06-01-SUMMARY.md`
</output>
