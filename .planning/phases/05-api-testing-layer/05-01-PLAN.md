---
phase: 05-api-testing-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - pnpm-lock.yaml
  - src/api/validation/schemas.ts
  - src/api/errors.ts
  - src/api/responses.ts
  - src/api/helpers.ts
  - src/api/index.ts
autonomous: true

must_haves:
  truths:
    - "Zod validates request bodies with type inference"
    - "Error responses follow RFC 9457 format"
    - "Helper functions extract context IDs from URL paths"
  artifacts:
    - path: "src/api/validation/schemas.ts"
      provides: "Zod schemas for all API endpoints"
      exports: ["createContextSchema", "appendMessagesSchema", "paginationSchema", "tokenBudgetSchema"]
    - path: "src/api/errors.ts"
      provides: "RFC 9457 error response helper"
      exports: ["errorResponse"]
    - path: "src/api/responses.ts"
      provides: "Success response helper"
      exports: ["successResponse"]
    - path: "src/api/helpers.ts"
      provides: "URL parsing utilities"
      exports: ["extractContextId", "isValidUUID"]
  key_links:
    - from: "src/api/validation/schemas.ts"
      to: "zod"
      via: "import { z }"
      pattern: "import.*z.*from.*zod"
---

<objective>
Create API foundation layer with Zod validation schemas and response helpers.

Purpose: Establish consistent patterns for request validation and error handling before implementing endpoints.
Output: Validation schemas, error/success response helpers, URL parsing utilities.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-api-testing-layer/05-RESEARCH.md

@src/repositories/types.ts
@api/health.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Zod and create validation schemas</name>
  <files>
    - package.json
    - pnpm-lock.yaml
    - src/api/validation/schemas.ts
  </files>
  <action>
Install Zod for request validation:
```bash
pnpm add zod
```

Create `src/api/validation/schemas.ts` with Zod schemas matching repository input types:

1. `createContextSchema` - Optional name field (max 255 chars)
2. `appendMessagesSchema` - Array of messages with:
   - role: enum ["user", "assistant", "system", "tool"]
   - content: string (required)
   - tokenCount: positive integer (optional)
   - toolCallId, toolName, model: strings (optional)
   - Minimum 1 message required
3. `paginationSchema` - Query params with coercion:
   - cursor: number (optional)
   - limit: number 1-1000, default 50 (optional)
   - order: "asc" | "desc", default "asc" (optional)
4. `tokenBudgetSchema` - Query param:
   - budget: positive integer (required)

Export TypeScript types via `z.infer<>` for each schema.
  </action>
  <verify>
```bash
pnpm build
```
TypeScript compiles with no errors. Zod appears in package.json dependencies.
  </verify>
  <done>All four Zod schemas compile and export inferred types.</done>
</task>

<task type="auto">
  <name>Task 2: Create response helpers and URL utilities</name>
  <files>
    - src/api/errors.ts
    - src/api/responses.ts
    - src/api/helpers.ts
    - src/api/index.ts
  </files>
  <action>
Create `src/api/errors.ts` with RFC 9457 Problem Details format:
- `errorResponse(status, title, detail?, errors?)` returns Response with:
  - `type`: URL like `https://api.kata-context.dev/errors/{status}`
  - `title`: Human-readable error title
  - `status`: HTTP status code
  - `detail`: Optional detailed message
  - `errors`: Optional validation errors object
  - Content-Type: `application/problem+json`

Create `src/api/responses.ts`:
- `successResponse<T>(status, data: T)` returns `Response.json(data, { status })`

Create `src/api/helpers.ts`:
- `extractContextId(pathname: string): string | null` - Extracts UUID from `/api/v1/contexts/{id}/...` paths using regex
- `isValidUUID(str: string): boolean` - Validates UUID format (v1-7, lowercase hex, correct structure)
- `parseJsonBody<T>(request: Request): Promise<T | null>` - Safe JSON parsing with try/catch, returns null on parse error

Create `src/api/index.ts` barrel export for all API utilities.
  </action>
  <verify>
```bash
pnpm build && pnpm lint
```
All files compile and pass linting.
  </verify>
  <done>Response helpers and URL utilities exported from src/api/index.ts.</done>
</task>

</tasks>

<verification>
After both tasks complete:
```bash
pnpm build
pnpm lint
```
All files in src/api/ compile with no TypeScript errors.
</verification>

<success_criteria>
1. Zod installed and schemas defined for all endpoint inputs
2. errorResponse produces RFC 9457-compliant JSON
3. successResponse wraps data in standard format
4. extractContextId correctly parses UUID from URL path
5. isValidUUID validates UUID format
6. All utilities compile with strict TypeScript
</success_criteria>

<output>
After completion, create `.planning/phases/05-api-testing-layer/05-01-SUMMARY.md`
</output>
