---
phase: 02-automation-and-deployment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - .husky/pre-commit
autonomous: true

must_haves:
  truths:
    - "Git commit triggers lint-staged which runs Biome on staged files"
    - "Pre-commit hook fails if lint errors exist in staged files"
    - "New clone runs `pnpm install` and hooks are automatically configured"
  artifacts:
    - path: "package.json"
      provides: "Husky prepare script and lint-staged configuration"
      contains: "lint-staged"
    - path: ".husky/pre-commit"
      provides: "Git pre-commit hook"
      contains: "lint-staged"
  key_links:
    - from: "package.json"
      to: ".husky/"
      via: "prepare script runs husky"
      pattern: '"prepare":\\s*"husky"'
    - from: ".husky/pre-commit"
      to: "lint-staged"
      via: "pnpm exec lint-staged"
      pattern: "pnpm exec lint-staged"
---

<objective>
Configure Husky v9 and lint-staged for pre-commit validation.

Purpose: Ensure code quality by running Biome lint/format on staged files before every commit. Prevents broken code from entering the repository.

Output: Working pre-commit hook that validates staged TypeScript/JSON files via Biome.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-automation-and-deployment/02-RESEARCH.md

@package.json
@biome.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Husky and lint-staged</name>
  <files>package.json</files>
  <action>
Install Husky v9 and lint-staged v16 as dev dependencies with exact versions:
```bash
pnpm add --save-dev --save-exact husky@9.1.7 lint-staged@16.2.7
```

Initialize Husky (creates .husky/ directory and adds prepare script):
```bash
pnpm exec husky init
```

Add lint-staged configuration to package.json:
```json
{
  "lint-staged": {
    "*.{js,ts,jsx,tsx,json,jsonc}": [
      "biome check --write --no-errors-on-unmatched --files-ignore-unknown=true"
    ]
  }
}
```

The `--no-errors-on-unmatched` flag handles deleted files. The `--files-ignore-unknown=true` flag skips files Biome doesn't recognize.
  </action>
  <verify>
- `pnpm list husky lint-staged` shows both packages installed
- `cat package.json | grep -A5 lint-staged` shows configuration
- `cat package.json | grep prepare` shows "husky" command
  </verify>
  <done>
- Husky 9.1.7 installed
- lint-staged 16.2.7 installed
- prepare script runs husky
- lint-staged configured to run biome check on staged files
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure pre-commit hook</name>
  <files>.husky/pre-commit</files>
  <action>
Replace the default .husky/pre-commit content with:
```bash
pnpm exec lint-staged
```

The `husky init` command creates a default pre-commit that runs `npm test`. We replace it with lint-staged since:
1. Tests are run in CI (not on every commit for speed)
2. lint-staged runs Biome on only staged files (fast)

Do NOT include shebang line - Husky v9 handles execution directly.
  </action>
  <verify>
Test the hook by staging and committing a file:
```bash
# Create a test file with intentional lint error
echo 'const x = 1' > src/test-hook.ts

# Stage it
git add src/test-hook.ts

# Attempt commit (should succeed - Biome will auto-fix the missing semicolon)
git commit -m "test: verify husky hook"

# Clean up
git reset --soft HEAD~1
git restore --staged src/test-hook.ts
rm src/test-hook.ts
```

Alternative verification (no commit):
```bash
# Check hook exists and has correct content
cat .husky/pre-commit
# Should output: pnpm exec lint-staged
```
  </verify>
  <done>
- .husky/pre-commit contains `pnpm exec lint-staged`
- Running `git commit` triggers lint-staged
- Biome validates staged files before commit completes
  </done>
</task>

</tasks>

<verification>
Verify the complete git hooks setup:

1. **Hook installation on fresh clone:**
```bash
# Simulate fresh install
rm -rf .husky/_
pnpm install
ls .husky/
# Should show: pre-commit
```

2. **Hook execution:**
```bash
# Stage package.json (known good file)
git add package.json
git commit --dry-run
# Should not error (lint-staged runs but --dry-run prevents actual commit)
```

3. **Package.json configuration:**
```bash
cat package.json | grep -A1 '"prepare"'
# Should show: "prepare": "husky"

cat package.json | grep -A5 '"lint-staged"'
# Should show lint-staged config with biome check command
```
</verification>

<success_criteria>
1. `pnpm install` on fresh clone installs git hooks automatically (via prepare script)
2. `git commit` on staged .ts/.json files runs Biome check via lint-staged
3. Lint errors in staged files prevent commit (exit code non-zero)
4. Auto-fixable issues are fixed by `biome check --write` before commit
</success_criteria>

<output>
After completion, create `.planning/phases/02-automation-and-deployment/02-01-SUMMARY.md`
</output>
