---
phase: 05-api-testing-layer
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - api/v1/contexts/index.ts
  - api/v1/contexts/[id]/index.ts
autonomous: true

must_haves:
  truths:
    - "POST /api/v1/contexts creates a new context"
    - "GET /api/v1/contexts/:id retrieves context by ID"
    - "DELETE /api/v1/contexts/:id soft-deletes context"
    - "Invalid UUID returns 400"
    - "Non-existent context returns 404"
  artifacts:
    - path: "api/v1/contexts/index.ts"
      provides: "POST /api/v1/contexts endpoint"
      exports: ["POST"]
    - path: "api/v1/contexts/[id]/index.ts"
      provides: "GET and DELETE /api/v1/contexts/:id endpoints"
      exports: ["GET", "DELETE"]
  key_links:
    - from: "api/v1/contexts/index.ts"
      to: "src/repositories/context.repository.ts"
      via: "ContextRepository.create()"
      pattern: "repository\\.create"
    - from: "api/v1/contexts/[id]/index.ts"
      to: "src/repositories/context.repository.ts"
      via: "ContextRepository.findById() and softDelete()"
      pattern: "repository\\.(findById|softDelete)"
---

<objective>
Implement REST endpoints for context CRUD operations.

Purpose: Expose ContextRepository operations via HTTP API for context creation, retrieval, and deletion.
Output: Three working endpoints: POST, GET, DELETE for contexts.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-api-testing-layer/05-RESEARCH.md

@api/health.ts
@src/repositories/context.repository.ts
@src/api/validation/schemas.ts
@src/api/errors.ts
@src/api/responses.ts
@src/api/helpers.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create POST /api/v1/contexts endpoint</name>
  <files>api/v1/contexts/index.ts</files>
  <action>
Create `api/v1/contexts/index.ts` following the health.ts pattern (named exports, web standard Request/Response).

Export `POST` function:
1. Parse JSON body with try/catch (return 400 on parse error)
2. Validate with `createContextSchema.safeParse()` (return 400 with errors on failure)
3. Call `repository.create(result.data)`
4. Return `successResponse(201, { data: context })`
5. Wrap in try/catch, log errors server-side, return 500 with generic message

Create ContextRepository instance at module scope (singleton pattern per research):
```typescript
import { db } from "../../../src/db/client.js";
import { ContextRepository } from "../../../src/repositories/index.js";

const repository = new ContextRepository(db);
```

Requirements covered: API-01
  </action>
  <verify>
```bash
pnpm build
```
File compiles. Deploy to Vercel preview and test:
```bash
curl -X POST https://[preview-url]/api/v1/contexts \
  -H "Content-Type: application/json" \
  -d '{"name": "Test Context"}'
```
Should return 201 with context data including generated UUID.
  </verify>
  <done>POST /api/v1/contexts creates context and returns 201 with context data.</done>
</task>

<task type="auto">
  <name>Task 2: Create GET and DELETE /api/v1/contexts/:id endpoints</name>
  <files>api/v1/contexts/[id]/index.ts</files>
  <action>
Create `api/v1/contexts/[id]/index.ts` with named exports for GET and DELETE.

For both functions:
1. Extract ID from URL using `extractContextId(new URL(request.url).pathname)`
2. Validate UUID format using `isValidUUID(id)` (return 400 if invalid)

**GET function:**
1. Call `repository.findById(id)`
2. If null, return `errorResponse(404, "Context not found")`
3. Return `successResponse(200, { data: context })`

**DELETE function:**
1. Call `repository.softDelete(id)`
2. If null (not found or already deleted), return `errorResponse(404, "Context not found")`
3. Return `successResponse(200, { data: context })` with the soft-deleted context

Both functions: wrap in try/catch, log errors, return 500 on unexpected errors.

Create repository instance at module scope (same pattern as Task 1).

Requirements covered: API-02, API-03
  </action>
  <verify>
```bash
pnpm build
```
Deploy and test full lifecycle:
```bash
# Create
ID=$(curl -s -X POST https://[preview-url]/api/v1/contexts \
  -H "Content-Type: application/json" \
  -d '{"name": "Test"}' | jq -r '.data.id')

# Read
curl https://[preview-url]/api/v1/contexts/$ID

# Delete
curl -X DELETE https://[preview-url]/api/v1/contexts/$ID

# Verify deleted (should 404)
curl https://[preview-url]/api/v1/contexts/$ID
```
  </verify>
  <done>GET returns context with 200, DELETE soft-deletes and returns 200, deleted context returns 404.</done>
</task>

</tasks>

<verification>
After both tasks:
```bash
pnpm build && pnpm lint
```

Test error cases:
- POST with invalid JSON returns 400
- GET with invalid UUID returns 400
- GET with non-existent UUID returns 404
- DELETE with non-existent UUID returns 404
</verification>

<success_criteria>
1. POST /api/v1/contexts accepts JSON body, returns 201 with created context
2. GET /api/v1/contexts/:id returns 200 with context data
3. DELETE /api/v1/contexts/:id returns 200 with soft-deleted context
4. Invalid UUID format returns 400 Bad Request
5. Non-existent context returns 404 Not Found
6. All endpoints follow RFC 9457 error format
</success_criteria>

<output>
After completion, create `.planning/phases/05-api-testing-layer/05-02-SUMMARY.md`
</output>
