# Milestone v0.2.0: Database + Storage Layer

**Status:** SHIPPED 2026-02-04
**Goal:** Establish the storage foundation for context persistence -- PostgreSQL schema, connection handling, and basic CRUD operations with REST API.
**Phases:** 3-5
**Total Plans:** 8

## Overview

v0.2.0 establishes the storage foundation for context persistence. Three phases build sequentially: database infrastructure and schema (Phase 3), repository abstraction layer (Phase 4), and REST API with comprehensive testing (Phase 5). Each phase delivers a complete, verifiable capability.

## Phases

### Phase 3: Database Foundation

**Goal**: PostgreSQL database is operational with type-safe schema and serverless-optimized connections.
**Depends on**: v0.1.0 project foundation (shipped)
**Plans**: 2 plans

Plans:
- [x] 03-01: Install Drizzle ORM, configure connection pooling, define schema
- [x] 03-02: Generate migration, verify database, update health endpoint

**Details:**
- Drizzle ORM 0.45.1 with pg 8.14.1 driver for Node.js serverless
- Contexts table: id, metadata (jsonb), parentId (fork tracking), createdAt, updatedAt, deletedAt (soft delete)
- Messages table: contextId, role, content, tokenCount, version (sequential), embedding (vector 1536)
- Vercel Fluid lifecycle integration via attachDatabasePool
- Health endpoint extended with database connectivity check (77ms latency verified)
- pgvector extension enabled for future semantic retrieval

### Phase 4: Repository Layer

**Goal**: Type-safe data access abstraction enables all CRUD operations without direct database coupling.
**Depends on**: Phase 3 (database foundation)
**Plans**: 2 plans

Plans:
- [x] 04-01: Repository foundation + testing setup (ContextRepository)
- [x] 04-02: Message repository + token windowing (MessageRepository)

**Details:**
- ContextRepository: create, findById, softDelete, exists with dual database type support
- MessageRepository: append (batch with FOR UPDATE locking), findByContext (cursor pagination), getByTokenBudget, findByVersion
- PGlite in-memory PostgreSQL for testing (no external database needed)
- 40 repository tests passing
- Repository pattern with typed error handling (RepositoryError)

### Phase 5: API + Testing Layer

**Goal**: REST API exposes context management operations with comprehensive test coverage.
**Depends on**: Phase 4 (repository layer)
**Plans**: 4 plans

Plans:
- [x] 05-01: API foundation: Zod validation schemas, response helpers, URL utilities
- [x] 05-02: Context endpoints: POST, GET, DELETE /api/v1/contexts
- [x] 05-03: Message endpoints: POST/GET messages, GET window
- [x] 05-04: Test coverage: Unit tests with mocks, integration tests with PGlite

**Details:**
- Zod v4 validation schemas for all request/response types
- RFC 9457 problem detail error format
- Singleton repository pattern at module scope for serverless lifecycle
- 6 REST endpoints: POST/GET/DELETE contexts, POST/GET messages, GET window
- 47 API tests (26 unit with mocks + 21 integration with PGlite)
- 100% coverage enforcement with @vitest/coverage-v8

---

## Milestone Summary

**Key Decisions:**
- Neon PostgreSQL over Vercel Postgres (deprecated Q4 2024)
- Drizzle ORM over Prisma (lighter, better serverless cold start)
- pg driver (not @neondatabase/serverless) for Node.js serverless runtime
- Repository pattern for data access abstraction
- Soft delete for contexts (preserve history)
- PGlite for testing (no external database dependency)
- Zod v4 with zod/v4 import path
- RFC 9457 error format for API responses
- Singleton repository at module scope for serverless

**Issues Resolved:**
- ESM/CJS interop for pg module in Vercel serverless
- TypeScript strict mode compatibility with array destructuring
- Vercel dev not executing serverless functions locally (added dev:local workaround)
- vi.hoisted for mock variable initialization before module loading

**Issues Deferred:**
- Embedding computation and storage (v0.3.0)
- Context forking API (v0.3.0)
- Point-in-time retrieval (v0.3.0)

**Technical Debt Incurred:**
- None significant

---

_For current project status, see .planning/ROADMAP.md_
