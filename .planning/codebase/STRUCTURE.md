# Codebase Structure

**Analysis Date:** 2026-02-02

## Directory Layout

```
kata-context/
├── .planning/          # Project planning, roadmaps, phase documentation
├── api/                # Vercel serverless function endpoints
├── dist/               # TypeScript build output (gitignored)
├── node_modules/       # Package dependencies (gitignored)
├── public/             # Static assets served by Vercel
├── scripts/            # Development utilities
├── src/                # Core application source
│   ├── db/            # Database client, schema, migrations
│   │   ├── schema/    # Drizzle table definitions
│   │   └── migrations/ # SQL migration files
│   └── repositories/  # Data access layer
└── (config files)      # Root-level configuration
```

## Directory Purposes

**`src/`:**
- Purpose: Core TypeScript source code
- Contains: Database layer, repositories, package entry point
- Key files: `src/index.ts`, `src/db/client.ts`

**`src/db/`:**
- Purpose: Database configuration and schema definitions
- Contains: Connection client, Drizzle schema files, generated migrations
- Key files: `src/db/client.ts`, `src/db/schema/index.ts`

**`src/db/schema/`:**
- Purpose: Type-safe table definitions using Drizzle ORM
- Contains: One file per table (`contexts.ts`, `messages.ts`), index barrel
- Key files: `src/db/schema/contexts.ts`, `src/db/schema/messages.ts`

**`src/db/migrations/`:**
- Purpose: SQL migration files generated by drizzle-kit
- Contains: Numbered migration SQL files, metadata snapshots
- Key files: `0000_adorable_nuke.sql`, `0001_majestic_maddog.sql`

**`src/repositories/`:**
- Purpose: Data access layer with repository pattern
- Contains: Repository classes, shared types, helper functions
- Key files: `src/repositories/context.repository.ts`, `src/repositories/message.repository.ts`, `src/repositories/types.ts`, `src/repositories/helpers.ts`

**`api/`:**
- Purpose: Vercel serverless function endpoints (HTTP handlers)
- Contains: One file per endpoint, each exports HTTP method handlers
- Key files: `api/health.ts`

**`scripts/`:**
- Purpose: Development and operational utilities
- Contains: Local dev server for API testing
- Key files: `scripts/dev-server.ts`

**`.planning/`:**
- Purpose: Project documentation, roadmaps, phase plans
- Contains: Subdirectories for research, milestones, phases, todos
- Key files: `.planning/PROJECT.md`, `.planning/ROADMAP.md`, `.planning/STATE.md`

**`public/`:**
- Purpose: Static assets served by Vercel at root path
- Contains: Index metadata file
- Key files: `public/index.json`

**`dist/`:**
- Purpose: TypeScript compilation output
- Contains: JavaScript files and type declarations
- Generated: Yes
- Committed: No

## Key File Locations

**Entry Points:**
- `src/index.ts`: Package entry point, exports VERSION constant
- `api/health.ts`: Health check serverless endpoint
- `scripts/dev-server.ts`: Local development server
- `vitest.setup.ts`: Test database initialization

**Configuration:**
- `package.json`: Project metadata, dependencies, scripts
- `tsconfig.json`: TypeScript compiler configuration (ES2023, NodeNext, strict mode)
- `drizzle.config.ts`: Drizzle Kit configuration for migrations
- `vitest.config.ts`: Vitest test runner configuration
- `biome.json`: Biome linter/formatter configuration
- `vercel.json`: Vercel deployment configuration

**Core Logic:**
- `src/db/client.ts`: Database connection pool with Vercel Fluid integration
- `src/repositories/context.repository.ts`: Context CRUD operations
- `src/repositories/message.repository.ts`: Message append, pagination, token budgeting

**Testing:**
- `src/repositories/context.repository.test.ts`: Context repository tests
- `src/repositories/message.repository.test.ts`: Message repository tests
- `vitest.setup.ts`: PGlite test database setup

## Naming Conventions

**Files:**
- `kebab-case.ts`: Source files (`context.repository.ts`)
- `kebab-case.test.ts`: Test files co-located with source
- `UPPERCASE.md`: Documentation files (`.planning/PROJECT.md`)
- `index.ts`: Barrel exports for directories

**Directories:**
- `kebab-case`: All directories use lowercase with hyphens
- Singular nouns for conceptual containers (`db`, `api`)
- Plural nouns for collections (`repositories`, `migrations`, `scripts`)

**TypeScript Exports:**
- `PascalCase`: Classes (`ContextRepository`, `MessageRepository`)
- `PascalCase`: Types/Interfaces (`Context`, `Message`, `RepositoryError`)
- `camelCase`: Functions (`notDeleted`, `handleDatabaseError`)
- `SCREAMING_SNAKE_CASE`: Constants (`VERSION`)

## Where to Add New Code

**New API Endpoint:**
- Primary code: `api/[endpoint-name].ts`
- Tests: Create integration test in `api/[endpoint-name].test.ts` (not yet implemented)
- Pattern: Export named HTTP method handlers (`GET`, `POST`, etc.)

**New Repository:**
- Implementation: `src/repositories/[entity].repository.ts`
- Tests: `src/repositories/[entity].repository.test.ts`
- Types: Add input/output types to `src/repositories/types.ts`
- Export: Add to `src/repositories/index.ts` barrel file

**New Database Table:**
- Schema: `src/db/schema/[table-name].ts`
- Export: Add to `src/db/schema/index.ts`
- Migration: Run `pnpm db:generate` to create migration file
- Pattern: Use Drizzle `pgTable()`, include soft delete `deletedAt` column, add appropriate indexes

**New Utility/Helper:**
- Shared helpers: `src/repositories/helpers.ts` (if repository-specific)
- General utilities: Create `src/utils/` directory for cross-cutting utilities

**New Configuration:**
- Root-level config files: Add to project root (e.g., `eslint.config.js`)
- Environment variables: Add to `.env.example` with documentation

## Special Directories

**`.planning/`:**
- Purpose: Project planning and documentation (Kata workflow artifacts)
- Generated: Manual/tooling-assisted
- Committed: Yes

**`.planning/codebase/`:**
- Purpose: Codebase analysis documents (this file lives here)
- Generated: Kata `/kata:map-codebase` command
- Committed: Yes

**`.planning/phases/`:**
- Purpose: Phase-by-phase implementation plans and summaries
- Generated: Kata `/kata:plan-phase` and `/kata:execute-phase` commands
- Committed: Yes

**`dist/`:**
- Purpose: TypeScript compilation output
- Generated: `pnpm build` command
- Committed: No (gitignored)

**`src/db/migrations/`:**
- Purpose: SQL migration files
- Generated: `pnpm db:generate` command
- Committed: Yes (migrations are part of version control)

**`src/db/migrations/meta/`:**
- Purpose: Drizzle Kit metadata for tracking migration state
- Generated: drizzle-kit automatically
- Committed: Yes

**`.husky/`:**
- Purpose: Git hooks for pre-commit linting
- Generated: `pnpm prepare` command
- Committed: Yes

**`.vercel/`:**
- Purpose: Vercel deployment configuration and project linking
- Generated: Vercel CLI
- Committed: No (gitignored)

**`.secrets/`:**
- Purpose: Local development secrets
- Generated: Manual
- Committed: No (gitignored)

---

*Structure analysis: 2026-02-02*
